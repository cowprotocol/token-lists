name: ProcessRequest

# Flow
# Extract info from issue (did not find a way to get it nicely)
# Validate all info is present
# On validation failure, comment on issue with reason for failure
# [Optional] Optimize image
# Create PR with required info
#   [Optional] Modify CowSwap.json list
#   [Optional] Add image to src/public/network/address/logo
#   [Optional] Add/Update info to src/public/network/address/info
#   Link Issue to PR
#   Add reviewers
#   [Optional] Notify on slack
# Comment on original issue

# Running locally with `act`
# Get the `event.json` from a GH action such as https://github.com/cowprotocol/token-lists/actions/runs/4251878894/jobs/7394780076
# ACTIONS_RUNTIME_URL=http://host.docker.internal:34567/ act -s GITHUB_TOKEN=$(gh auth token) issues -e event.json -W .github/workflows/processRequest.yml --artifact-server-path /tmp/artifacts --artifact-server-addr "[::0]" -v
# Some of the additional workarounds are required for running artifact uploading on Mac M1s locally. See https://github.com/nektos/act/issues/329

on:
  issues:
    types: [opened]

env:
  # Matches labels from field forms to extract data
  FIELD_NAMES: 'Network,Symbol,Name,URL,Decimals,Address,Reason'
  IMAGES_BASE_PATH: src/public/images/
  LIST_PATH: src/public/CowSwap.json

jobs:
  printContext:
    runs-on: ubuntu-latest
    steps:
      - env:
          EVENT_CONTEXT: ${{ toJSON(github.event) }}
        run: |
          echo $EVENT_CONTEXT

  extractInfoFromIssue:
    runs-on: ubuntu-latest
    outputs:
      issueInfo: ${{ steps.extractInfo.outputs.result }}
    steps:
      - name: Give feedback to issue creator
        uses: peter-evans/create-or-update-comment@v2
        if: ${{ !github.event.act }} # skip during local actions testing https://github.com/nektos/act#skipping-jobs
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            Your request has been received and is being processed.
            
            This issue will be updated when completed.

      - name: Extract info
        id: extractInfo
        uses: actions/github-script@v6
        with:
          # Using JS, build a new comment body
          script: |
            const body = context.payload.issue.body
            
            const fieldNames = `${ process.env.FIELD_NAMES }`.split(',')
            
            // Extract the values for each field - if it exists - based on their labels from the issue body
            const values = fieldNames.reduce((acc, f) => {
              // Create a regex for each field, with capturing group with the same name
              const r = new RegExp(String.raw`${f}\s+(?<${f.toLowerCase()}>.*?)(\s+###|$)`, 's')
            
              // Build an object with the capturing group and value for each field
              return {...acc, ...body.match(r)?.groups}
            }, {})
            
            if (values.network === 'MAINNET') {
              values.chainId = 1
              values.blockExplorer = 'etherscan'
            } else {
              values.chainId = 100
              values.blockExplorer = 'gnosisscan'
            }
            
            // Used only in the PR context for displaying it
            values.prImageUrl = `https://raw.githubusercontent.com/cowprotocol/token-lists/addImage/${ values.chainId }_${ values.address }/src/public/images/${ values.chainId }/${ values.address }/logo.png`
            // Will be the final URL once it's merged to `main`
            values.logoURI = `https://raw.githubusercontent.com/cowprotocol/token-lists/main/src/public/images/${ values.chainId }/${ values.address }/logo.png`
            
            
            // Return a string
            return JSON.stringify(values)
          result-encoding: string

      - name: Debug
        run: |
          cat << EOF
          ${{ steps.extractInfo.outputs.result }}
          EOF
          
          # force failure for testing
          # exit 1
          

  validateInput:
    runs-on: ubuntu-latest
    needs: extractInfoFromIssue
    env:
      # De-normalizing for easier access
      NETWORK: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).network }}
      SYMBOL: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).symbol }}
      NAME: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).name }}
      URL: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).url }}
      DECIMALS: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).decimals }}
      ADDRESS: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }}
      REASON: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).reason }}

    steps:
      - name: Validate addImage
        if: contains(github.event.issue.labels.*.name, 'addImage') && (!env.NETWORK || !env.URL || !env.ADDRESS)
        run: |
          echo "::error title={Validation failed}::{Missing required fields for adding an image}"
          exit 1
      - name: Validate addToken
        if: contains(github.event.issue.labels.*.name, 'addToken') && (!env.NETWORK|| !env.SYMBOL|| !env.NAME|| !env.URL|| !env.DECIMALS|| !env.ADDRESS|| !env.REASON)
        run: |
          echo "${{ env.NETWORK }} ${{ env.URL }} ${{ env.ADDRESS }}"
          echo "::error title={Validation failed}::{Missing required fields for adding a token}"
          exit 1
      - name: Validate removeToken
        if: contains(github.event.issue.labels.*.name, 'removeToken') && (!env.NETWORK || !env.REASON || !env.ADDRESS)
        run: |
          echo "${{ env.NETWORK }} ${{ env.URL }} ${{ env.ADDRESS }}"
          echo "::error title={Validation failed}::{Missing required fields for removing a token}"
          exit 1
      - name: Report error
        if: ${{ failure() }}
        uses: peter-evans/close-issue@v2
        with:
          comment: |
            Your request is invalid 
            
            Make sure all the required fields are provided and submit a new issue 
        

  callOptimizeImageWorkflow:
    needs: [extractInfoFromIssue, validateInput]
    uses: ./.github/workflows/optimizeImage.yml
    if: ${{ contains(github.event.issue.labels.*.name, 'addImage') || contains(github.event.issue.labels.*.name, 'addToken') }}
    with:
      url: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).url }}
      address: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }}

  addToken2:
    needs: [ extractInfoFromIssue, callOptimizeImageWorkflow ]
    uses: ./.github/workflows/executeAction.yml
    if: ${{ contains(github.event.issue.labels.*.name, 'addToken') }}
    secrets: inherit
    with:
      # Same for all
#      network: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).network }}
#      address: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }}
#      symbol: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).symbol }}
#      name: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).name }}
#      logoURI: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).logoURI }}
#      decimals: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).decimals }}
#      reason: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).reason }}
#      chainId: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).chainId }}
      issueInfo: ${{ needs.extractInfoFromIssue.outputs.issueInfo }}
      # Custom per type
      operation: addToken
      prTitle: "[addToken] `${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).symbol }}` to `${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).network }}`"
      prBody: |
        Adding token `${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).symbol }}` on network `${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).network }}`
        
        *Address*: `${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }}`
        
        [Link to block explorer ↗︎](https://${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).blockExplorer }}.io/token/${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }})
        
        | Description | Image |
        |-|-|
        | Original | ![original](${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).url }}) |
        | Optimized | ![optimized](${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).prImageUrl }}) |
        
        ### Reason
        
        ```
        ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).reason }}
        ```

  removeToken2:
    needs: [ extractInfoFromIssue, validateInput ]
    uses: ./.github/workflows/executeAction.yml
    if: ${{ contains(github.event.issue.labels.*.name, 'removeToken') }}
    secrets: inherit
    with:
      # Same for all
#      network: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).network }}
#      chainId: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).chainId }}
#      address: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }}
#      reason: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).reason }}
      issueInfo: ${{ needs.extractInfoFromIssue.outputs.issueInfo }}
      # Custom per type
      operation: removeToken
      prTitle: "[removeToken] `${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }}` from `${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).network }}`"
      prBody: |
        Removing token from network `${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).network }}`
        
        *Address*: `${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }}`
        
        [Link to block explorer ↗︎](https://${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).blockExplorer }}.io/token/${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }})
        
        ### Reason
        
        ```
        ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).reason }}
        ```

  addImage2:
    needs: [ extractInfoFromIssue, callOptimizeImageWorkflow ]
    uses: ./.github/workflows/executeAction.yml
    if: ${{ contains(github.event.issue.labels.*.name, 'addImage') }}
    secrets: inherit
    with:
      # Same for all
#      network: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).network }}
#      address: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }}
#      chainId: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).chainId }}
#      logoURI: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).logoURI }}
      issueInfo: ${{ needs.extractInfoFromIssue.outputs.issueInfo }}
      # Custom per type
      operation: addImage
      prTitle: "[addImage] `${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }}` to `${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).network }}`"
      prBody: |
        Adding image to network `${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).network }}`
        
        *Address*: `${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }}`
        
        [Link to block explorer ↗︎](https://${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).blockExplorer }}.io/token/${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }})
        
        | Description | Image |
        |-|-|
        | Original | ![original](${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).url }}) |
        | Optimized | ![optimized](${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).prImageUrl }}) |

#  addToken:
#    runs-on: ubuntu-latest
#    needs: [ extractInfoFromIssue, callOptimizeImageWorkflow ]
#    if: ${{ contains(github.event.issue.labels.*.name, 'addToken') }}
#
#    env:
#      NETWORK: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).network }}
#      SYMBOL: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).symbol }}
#      NAME: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).name }}
#      URL: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).url }}
#      DECIMALS: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).decimals }}
#      ADDRESS: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }}
#      REASON: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).reason }}
#      CHAIN: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).chain }}
#      BLOCK_EXPLORER: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).blockExplorer }}
#      PR_IMAGE_URL: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).prImageUrl }}
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v3
#
#      # Image handling
#      - name: Download image
#        uses: actions/download-artifact@v3
#        with:
#          name: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }}
#      - name: Set BASE_PATH env var
#        run: echo "BASE_PATH=${{ env.IMAGES_BASE_PATH }}${{ env.CHAIN }}/${{ env.ADDRESS }}/" >> "$GITHUB_ENV"
#      - name: Handle image
#        run: |
#          # Create image dir
#          mkdir -p ${{ env.BASE_PATH }}
#
#          # Move image to destination
#          mv output.png ${{ env.BASE_PATH }}logo.png
#
#          # Touch
#          touch ${{ env.BASE_PATH }}info.json
#
#          echo "${{ env.BASE_PATH }}"
#          ls ${{ env.BASE_PATH }}
#
#      - name: Save stuff in a file
#        run: |
#          cat << EOF > data.json
#          ${{ needs.extractInfoFromIssue.outputs.issueInfo }}
#          EOF
#
#      # Token list handling
#      - name: Update token list
#        run: python3 src/scripts/workflow_helper.py add_update data.json
#
#      - name: Create Pull Request
#        id: cpr
#        uses: peter-evans/create-pull-request@v4
#        with:
#          commit-message: "[addToken] ${{ env.NETWORK }}/${{ env.SYMBOL }}/${{ env.ADDRESS }}"
#          branch: addToken/${{ env.CHAIN }}_${{ env.ADDRESS }}
#          delete-branch: true
#          title: "[addToken] `${{ env.SYMBOL }}` to `${{ env.NETWORK }}`"
#          body: |
#            # Add token
#
#            **Note** This is an automated PR
#
#            Adding token ${{ env.SYMBOL }} on ${{ env.NETWORK }} with address [${{ env.ADDRESS }}](https://${{ env.BLOCK_EXPLORER }}.io/token/${{ env.ADDRESS }})
#
#            Submitted by @${{ github.event.issue.user.login }}
#
#            Closes #${{ github.event.issue.number }}
#
#            | Description | Image |
#            |-|-|
#            | Original | ![original](${{ env.URL }}) |
#            | Optimized | ![optimized](${{ env.PR_IMAGE_URL }}) |
#
#          #          assignees: ${{ github.author }}
#          #          reviewers: |
#          #            cmagan
#          #            alfetopito
#          #          team-reviewers: @cowprotocol/frontend
#          add-paths: |
#            ${{ env.BASE_PATH }}/*
#            ${{ env.LIST_PATH }}
#
#      - name: Comment on issue
#        uses: peter-evans/create-or-update-comment@v2
#        with:
#          issue-number: ${{ github.event.issue.number }}
#          body: |
#            Your request has been received and will be reviewed by a team member.
#            You can follow the progress in the Pull Request #${{ steps.cpr.outputs.pull-request-number }}
#
#      - name: Report error
#        if: ${{ failure() }}
#        uses: peter-evans/close-issue@v2
#        with:
#          comment: |
#            Failed to add token
#
#            Check the input is correct and try again in a new issue
#
#            If the issue persists, create a bug report
#
#            cc @cowprotocol/frontend
#
#  addImage:
#    runs-on: ubuntu-latest
#    needs: [extractInfoFromIssue, callOptimizeImageWorkflow]
#    if: ${{ contains(github.event.issue.labels.*.name, 'addImage') }}
#
#    env:
#      CHAIN: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).chain }}
#      NETWORK: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).network }}
#      ADDRESS: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }}
#      BLOCK_EXPLORER: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).blockExplorer }}
#      URL: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).url }}
#      PR_IMAGE_URL: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).prImageUrl }}
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v3
#
#      - name: Set BASE_PATH env var
#        run: echo "BASE_PATH=${{ env.IMAGES_BASE_PATH }}${{ env.CHAIN }}/${{ env.ADDRESS }}/" >> "$GITHUB_ENV"
#
#      - name: Create image dir
#        run: mkdir -p ${{ env.BASE_PATH }}
#
#      - name: Download image
#        uses: actions/download-artifact@v3
#        with:
#          name: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }}
#
#      - name: Move image to destination
#        run: mv output.png ${{ env.BASE_PATH }}logo.png
#
#      - name: Create info.json if it doesn't exist
#        run: |
#          [ -e "${{ env.BASE_PATH }}info.json" ] || echo "{}" > ${{ env.BASE_PATH }}info.json
#
#      # TODO: update image link on list if image is there?
#
#      - name: Create Pull Request
#        id: cpr
#        uses: peter-evans/create-pull-request@v4
#        with:
#          commit-message: "[addImage] ${{ env.NETWORK }}/${{ env.ADDRESS }}"
#          branch: addImage/${{ env.CHAIN }}_${{ env.ADDRESS }}
#          delete-branch: true
#          title: "[addImage] To ${{ env.NETWORK }} for token ${{ env.ADDRESS }}"
#          body: |
#            # Add Image
#
#            **Note** This is an automated PR
#
#            Adding image for token ${{ env.NETWORK }} with address [${{ env.ADDRESS }}](https://${{ env.BLOCK_EXPLORER }}.io/token/${{ env.ADDRESS }})
#
#            Submitted by @${{ github.event.issue.user.login }}
#
#            Closes #${{ github.event.issue.number }}
#
#            | Description | Image |
#            |-|-|
#            | Original | ![original](${{ env.URL }}) |
#            | Optimized | ![optimized](${{ env.PR_IMAGE_URL }}) |
#
##          assignees: ${{ github.author }}
##          reviewers: |
##            cmagan
##            alfetopito
##          team-reviewers: @cowprotocol/frontend
#          add-paths: |
#            ${{ env.BASE_PATH }}/*
#            ${{ env.LIST_PATH }}
#
#      - name: Comment on issue
#        uses: peter-evans/create-or-update-comment@v2
#        with:
#          issue-number: ${{ github.event.issue.number }}
#          body: |
#            Your request has been received and will be reviewed by a team member.
#            You can follow the progress in the Pull Request #${{ steps.cpr.outputs.pull-request-number }}
#
#      - name: Report error
#        if: ${{ failure() }}
#        uses: peter-evans/close-issue@v2
#        with:
#          comment: |
#            Failed to add image
#
#            Check the input is correct and try again in a new issue
#
#            If the issue persists, create a bug report
#
#            cc @cowprotocol/frontend
#
#
#  removeToken:
#    runs-on: ubuntu-latest
#    needs: [extractInfoFromIssue, validateInput]
#    if: ${{ contains(github.event.issue.labels.*.name, 'removeToken') }}
#
#    env:
#      CHAIN: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).chain }}
#      NETWORK: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).network }}
#      ADDRESS: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).address }}
#      BLOCK_EXPLORER: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).blockExplorer }}
#      REASON: ${{ fromJSON(needs.extractInfoFromIssue.outputs.issueInfo).reason }}
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v3
#
#      - name: Set BASE_PATH env var
#        run: echo "BASE_PATH=${{ env.IMAGES_BASE_PATH }}${{ env.CHAIN }}/${{ env.ADDRESS }}/" >> "$GITHUB_ENV"
#
#      - name: Create info.json if it doesn't exist
#        run: |
#          mkdir -p ${{ env.BASE_PATH }}
#          touch "${{ env.BASE_PATH }}info.json"
#
#      - name: Save stuff in a file
#        run: |
#          cat << EOF > data.json
#          ${{ needs.extractInfoFromIssue.outputs.issueInfo }}
#          EOF
#
#      # Token list handling
#      - name: Update token list
#        run: python3 src/scripts/workflow_helper.py remove data.json
#
#      - name: Create Pull Request
#        id: cpr
#        uses: peter-evans/create-pull-request@v4
#        with:
#          commit-message: "[removeToken] ${{ env.NETWORK }}/${{ env.ADDRESS }}"
#          branch: removeToken/${{ env.CHAIN }}_${{ env.ADDRESS }}
#          delete-branch: true
#          title: "[removeToken] From ${{ env.NETWORK }} for token ${{ env.ADDRESS }}"
#          body: |
#            # Remove token
#
#            **Note** This is an automated PR
#
#            Removing token on ${{ env.NETWORK }} with address [${{ env.ADDRESS }}](https://${{ env.BLOCK_EXPLORER }}.io/token/${{ env.ADDRESS }})
#
#            Submitted by @${{ github.event.issue.user.login }}
#
#            Closes #${{ github.event.issue.number }}
#
#            ### Reason:
#            ```
#            ${{ env.REASON }}
#            ```
#
#          #          assignees: ${{ github.author }}
#          #          reviewers: |
#          #            cmagan
#          #            alfetopito
#          #          team-reviewers: @cowprotocol/frontend
#          add-paths: |
#            ${{ env.BASE_PATH }}/*
#            ${{ env.LIST_PATH }}
#
#      - name: Comment on issue
#        uses: peter-evans/create-or-update-comment@v2
#        with:
#          issue-number: ${{ github.event.issue.number }}
#          body: |
#            Your request has been received and will be reviewed by a team member.
#            You can follow the progress in the Pull Request #${{ steps.cpr.outputs.pull-request-number }}
#
#      - name: Report error
#        if: ${{ failure() }}
#        uses: peter-evans/close-issue@v2
#        with:
#          comment: |
#            Failed to remove token
#
#            Check the input is correct and try again in a new issue
#
#            If the issue persists, create a bug report
#
#            cc @cowprotocol/frontend